<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入出庫記録ツール</title>

    <style>
        /* --- 基本リセット & 変数 --- */
        :root {
            --bg-gray-50: #f9fafb;
            --bg-gray-100: #f3f4f6;
            --bg-gray-200: #e5e7eb;
            --bg-gray-300: #d1d5db;
            --bg-blue-50: #eff6ff;
            --bg-blue-500: #3b82f6;
            --bg-blue-600: #2563eb;
            --bg-blue-700: #1d4ed8;
            --bg-green-500: #22c55e;
            --bg-green-600: #16a34a;
            --bg-green-700: #15803d;
            --bg-gray-500: #6b7280;
            --bg-gray-600: #4b5563;
            --text-gray-400: #9ca3af;
            --text-gray-500: #6b7280;
            --text-gray-600: #4b5563;
            --text-gray-700: #374151;
            --text-gray-800: #1f2937;
            --text-blue-600: #2563eb;
            --text-blue-700: #1d4ed8;
            --border-gray-200: #e5e7eb;
            --border-gray-300: #d1d5db;
            --border-blue-300: #93c5fd;
        }

        body {
            margin: 0;
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 3rem 1rem;
            box-sizing: border-box;
            color: var(--text-gray-800);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        /* ★修正1: fieldsetの枠線を消す */
        fieldset {
            border: none;
            padding: 0;
            margin: 0;
            min-width: 0;
        }

        /* --- レイアウトユーティリティ --- */
        .w-full { width: 100%; }
        .max-w-lg { max-width: 32rem; }
        .max-w-xs { max-width: 20rem; }
        .h-full { height: 100%; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mr-1\.5 { margin-right: 0.375rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-8 { padding: 2rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-10 { padding-top: 2.5rem; padding-bottom: 2.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }

        /* --- Flex & Grid --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .flex-grow { flex-grow: 1; }
        .flex-1 { flex: 1 1 0%; }
        .flex-auto { flex: 1 1 auto; }
        .gap-x-2 { column-gap: 0.5rem; }
        .gap-x-4 { column-gap: 1rem; }
        .gap-4 { gap: 1rem; }
        
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-7 { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .col-span-2 { grid-column: span 2 / span 2; }
        .col-span-5 { grid-column: span 5 / span 5; }

        @media (min-width: 768px) {
            .md\:grid-cols-3, .md-grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:col-span-2, .md-col-span-2 { grid-column: span 2 / span 2; }
        }

        /* --- スペーシング --- */
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .space-y-5 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.25rem; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }

        /* --- コンポーネントスタイル --- */
        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: var(--bg-gray-50); }
        .bg-blue-50 { background-color: var(--bg-blue-50); }
        
        .rounded-md { border-radius: 0.375rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-full { border-radius: 9999px; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }

        .border { border-width: 1px; border-style: solid; }
        .border-t-2 { border-top-width: 2px; border-style: solid; }
        .border-b { border-bottom-width: 1px; border-style: solid; }
        .border-gray-200 { border-color: var(--border-gray-200); }
        .border-gray-300 { border-color: var(--border-gray-300); }
        .border-blue-300 { border-color: var(--border-blue-300); }

        /* タイポグラフィ */
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-md { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* テキストカラー */
        /* ★修正2: 文字色の優先度を上げる (!important) */
        .text-white { color: white !important; } 
        .text-gray-400 { color: var(--text-gray-400); }
        .text-gray-500 { color: var(--text-gray-500); }
        .text-gray-600 { color: var(--text-gray-600); }
        .text-gray-700 { color: var(--text-gray-700); }
        .text-gray-800 { color: var(--text-gray-800); }
        .text-blue-600 { color: var(--text-blue-600); }
        .text-blue-700 { color: var(--text-blue-700); }
        .text-green-500 { color: var(--bg-green-500); }

        /* --- フォーム要素 --- */
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            display: block;
            width: 100%;
            border: 1px solid var(--border-gray-300);
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            font-size: 1.125rem;
            background-color: white;
            appearance: none; /* ブラウザデフォルトのスタイルを消す */
        }
        input:disabled {
            background-color: var(--bg-gray-200);
            cursor: not-allowed;
        }

        /* --- ボタン & 動的カラー --- */
        button {
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .bg-gray-100 { background-color: var(--bg-gray-100); }
        .bg-gray-200 { background-color: var(--bg-gray-200); }
        .bg-gray-300 { background-color: var(--bg-gray-300); }
        
        .bg-blue-500 { background-color: var(--bg-blue-500); }
        .bg-blue-600 { background-color: var(--bg-blue-600); }
        .bg-blue-600:hover:not(:disabled) { background-color: var(--bg-blue-700); }
        
        .bg-green-500 { background-color: var(--bg-green-500); }
        .bg-green-600 { background-color: var(--bg-green-600); }
        .bg-green-600:hover:not(:disabled) { background-color: var(--bg-green-700); }

        .bg-gray-500 { background-color: var(--bg-gray-500); }
        .bg-gray-500:hover:not(:disabled) { background-color: var(--bg-gray-600); }

        /* --- ユーティリティ --- */
        .hidden { display: none !important; }
        .block { display: block; }
        .opacity-0 { opacity: 0; }
        .opacity-50 { opacity: 0.5; }
        .transition-opacity { transition: opacity 0.3s ease-in-out; }
        .duration-300 { transition-duration: 300ms; }
        .duration-500 { transition-duration: 500ms; }
        .ease-in-out { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- アニメーション --- */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* --- アイコンサイズ --- */
        .w-5 { width: 1.25rem; }
        .h-5 { height: 1.25rem; }
        .w-6 { width: 1.5rem; }
        .h-6 { height: 1.5rem; }
        .w-8 { width: 2rem; }
        .h-8 { height: 2rem; }
        .w-16 { width: 4rem; }
        .h-16 { height: 4rem; }
        .w-20 { width: 5rem; }
        .h-20 { height: 5rem; }
        
        .w-3\/4 { width: 75%; }
        .w-1\/4 { width: 25%; }
        .h-4 { height: 1rem; }
        .h-5 { height: 1.25rem; }
        .h-8 { height: 2rem; }
        .h-10 { height: 2.5rem; }

    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen py-12">
  <div class="w-full max-w-lg p-8 space-y-6 bg-white rounded-xl shadow-lg">
    
    <div id="status-message" class="space-y-6 py-4 animate-pulse transition-opacity duration-300 ease-in-out">
      <div class="h-8 bg-gray-300 rounded-md w-3/4 mx-auto"></div>
      <div class="flex items-center w-full mx-auto mt-6">
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-gray-300"></div>
          <div class="h-4 bg-gray-300 rounded-md w-16 mt-1"></div>
        </div>
        <div class="flex-auto border-t-2 border-gray-200 mx-2"></div>
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-gray-300"></div>
          <div class="h-4 bg-gray-300 rounded-md w-16 mt-1"></div>
        </div>
        <div class="flex-auto border-t-2 border-gray-200 mx-2"></div>
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full bg-gray-300"></div>
          <div class="h-4 bg-gray-300 rounded-md w-16 mt-1"></div>
        </div>
      </div>
      <div class="space-y-5 mt-8">
        <div>
          <div class="h-5 bg-gray-300 rounded-md w-1/4 mb-2"></div>
          <div class="h-10 bg-gray-300 rounded-md w-full"></div>
        </div>
        <div>
          <div class="h-5 bg-gray-300 rounded-md w-1/4 mb-2"></div>
          <div class="h-10 bg-gray-300 rounded-md w-full"></div>
        </div>
      </div>
      <div class="pt-4 text-center">
        <p id="loading-status-text" class="text-sm font-medium text-gray-500">
          アプリを起動しています...
        </p>
      </div>
    </div>
        
    <div id="main-content" style="display: none;" class="opacity-0 transition-opacity duration-500 ease-in-out">
      <h1 id="main-title" class="text-2xl font-bold text-center text-gray-800">出庫登録ツール</h1>
            
      <div id="progress-bar" class="flex items-center w-full mx-auto mt-6">
          <div class="flex flex-col items-center text-blue-600">
              <div id="step1-circle" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">1</div>
              <p class="text-sm font-semibold mt-1">情報入力</p>
          </div>
          <div id="progress-line1" class="flex-auto border-t-2 border-gray-300 transition-colors duration-500 mx-2"></div>
          <div class="flex flex-col items-center text-gray-400">
              <div id="step2-circle" class="w-8 h-8 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold">2</div>
              <p class="text-sm font-semibold mt-1">品目登録</p>
          </div>
          <div id="progress-line2" class="flex-auto border-t-2 border-gray-300 transition-colors duration-500 mx-2"></div>
          <div class="flex flex-col items-center text-gray-400">
              <div id="step3-circle" class="w-8 h-8 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold">3</div>
              <p class="text-sm font-semibold mt-1">内容確認</p>
          </div>
      </div>
            
      <div id="register-progress-info" class="hidden flex items-center justify-center w-full mx-auto mt-6 h-[68px] bg-gray-50 rounded-md border border-gray-200">
        <p class="text-sm font-semibold text-gray-600 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
          </svg>
          新規物品 仮登録モード
        </p>
      </div>
            
      <div id="page1">
          <fieldset id="page1-fieldset">
              <!-- 初心者向け説明セクション -->
              <div id="help-section" style="background-color: #eff6ff; border: 1px solid #93c5fd; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleHelp()">
                      <p style="font-size: 0.875rem; font-weight: 600; color: #1d4ed8; margin: 0; display: flex; align-items: center;">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
                          </svg>
                          使い方ガイド
                      </p>
                      <svg id="help-toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="#1d4ed8" style="width: 1rem; height: 1rem; transition: transform 0.2s;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                      </svg>
                  </div>
                  <div id="help-content" style="display: none; margin-top: 0.75rem; font-size: 0.8125rem; color: #374151; line-height: 1.5;">
                      <p style="margin: 0 0 0.5rem 0;"><strong>このツールについて</strong></p>
                      <p style="margin: 0 0 0.75rem 0;">薬品・資材の入庫（納品）と出庫（使用）を記録するツールです。</p>

                      <p style="margin: 0 0 0.5rem 0;"><strong>3ステップで完了</strong></p>
                      <ol style="margin: 0 0 0.75rem 0; padding-left: 1.25rem;">
                          <li><strong>情報入力</strong>：担当者と日付を確認</li>
                          <li><strong>品目登録</strong>：品名と個数を入力して追加</li>
                          <li><strong>内容確認</strong>：入力内容を確認して登録</li>
                      </ol>

                      <p style="margin: 0 0 0.5rem 0;"><strong>入庫・出庫の切り替え</strong></p>
                      <p style="margin: 0;">右下の「<span style="color: #6b7280; font-weight: 600;">入庫</span>」ボタンで切り替えられます。<br>
                      出庫 = 在庫から取り出す（マイナス）<br>
                      入庫 = 在庫に追加する（プラス）</p>
                  </div>
              </div>

              <div style="margin-top: 0.5rem;">
                  <div id="registrant-section">
                      <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">担当者名</label>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                          <div id="registrant-display-container" style="flex-grow: 1; display: flex; align-items: center;">
                              <p id="registrant-display" style="font-size: 1.125rem; padding: 0.75rem 1rem; background-color: #f3f4f6; border-radius: 0.375rem; width: 100%; margin: 0;">（読み込み中...）</p>
                          </div>
                          <select id="registrant-select" style="flex-grow: 1; display: none;"></select>
                          <input type="hidden" id="registrant-name" value="">
                          <button type="button" id="change-user-btn" style="display: none; padding: 0.75rem 1rem; background-color: #6b7280; color: white; font-weight: 600; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;">変更</button>
                      </div>
                      <div id="admin-link-placeholder" style="margin: 0.5rem 0; font-size: 0.875rem;"></div>
                  </div>
                  <div id="date-section" style="margin-top: 1rem;">
                      <label for="date-input" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">日付</label>
                      <input type="date" id="date-input" style="width: 100%;" required>
                  </div>
              </div>

              <div style="display: grid; grid-template-columns: 5fr 2fr; gap: 1rem; margin-top: 2rem;">
                  <button id="next-btn" style="width: 100%; padding: 0.75rem 1rem; background-color: #2563eb; color: white; font-weight: 700; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;" disabled>次へ進む</button>
                  <button id="toggle-mode-button" type="button" style="width: 100%; padding: 0.75rem 1rem; background-color: #6b7280; color: white; font-weight: 700; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;">入庫</button>
              </div>
          </fieldset>
      </div>
      
      <div id="page2" style="display: none;">
          <div style="margin-top: 2rem;">
              <fieldset id="inbound-fields" style="display: none; border: 1px solid #93c5fd; background-color: #eff6ff; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                  <legend style="font-size: 1.125rem; font-weight: 600; padding: 0 0.5rem; color: #1d4ed8;">入庫情報</legend>
                  <div>
                      <div id="photo-upload-section">
                          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">伝票写真 (任意)</label>
                          <div style="display: flex; gap: 0.5rem;">
                              <button type="button" id="select-file-btn" style="flex: 1; padding: 0.5rem 1rem; background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; color: #374151; cursor: pointer;">ファイルを選択</button>
                              <button type="button" id="launch-camera-btn" style="display: none; flex: 1; padding: 0.5rem 1rem; background-color: #3b82f6; color: white; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; border: none; cursor: pointer;">カメラを起動</button>
                          </div>
                          <p id="file-name-display" style="font-size: 0.875rem; color: #4b5563; margin-top: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></p>
                          <input type="file" id="voucher-photo-file" style="display: none;" accept="image/*">
                          <input type="file" id="voucher-photo-camera" style="display: none;" accept="image/*" capture="environment">
                      </div>
                      <div id="voucher-number-input-group" style="margin-top: 1rem;">
                          <label for="voucher-number" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">伝票番号 (写真選択後に有効化)</label>
                          <input type="text" id="voucher-number" placeholder="ファイル名になります" style="width: 100%;" disabled>
                      </div>
                  </div>
              </fieldset>
              <fieldset id="item-add-section" style="border: 1px solid #d1d5db; padding: 1rem; border-radius: 0.375rem;">
                  <legend id="item-section-legend" style="font-size: 1.125rem; font-weight: 600; padding: 0 0.5rem; color: #374151;">出庫品目</legend>
                  <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                      <div>
                          <label for="item-name" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">品名</label>
                          <input type="text" id="item-search" placeholder="品名を検索..." style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem;">
                          <select id="item-name" style="width: 100%;">
                              <option value="" disabled selected>-- 品名を選択 --</option>
                          </select>
                      </div>
                      <div>
                          <label for="quantity" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">個数</label>
                          <input type="number" id="quantity" placeholder="個数" style="width: 100%;">
                      </div>
                  </div>
                  <button id="add-item-button" type="button" style="width: 100%; margin-top: 1rem; padding: 0.75rem 1rem; background-color: #22c55e; color: white; font-weight: 700; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;" disabled>品目を追加</button>
              </fieldset>
              <div id="added-items-container" style="margin-top: 1rem;">
                  <h3 style="font-size: 1rem; font-weight: 600; color: #374151;">追加済みリスト</h3>
                  <div id="added-items-list" style="margin-top: 0.5rem; padding: 0.75rem; background-color: #f9fafb; border-radius: 0.375rem; border: 1px solid #e5e7eb; min-height: 50px;"></div>
              </div>
          </div>
          <button id="confirm-button" type="button" style="width: 100%; margin-top: 1.5rem; padding: 0.75rem 1rem; background-color: #2563eb; color: white; font-weight: 700; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;" disabled>内容を確認する</button>
          <button id="back-to-page1-btn" type="button" style="width: 100%; margin-top: 1rem; padding: 0.75rem 1rem; background-color: white; color: #374151; font-weight: 700; font-size: 1.125rem; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer;">戻る</button>
      </div>
      
      <div id="page3" style="display: none;">
          <div style="margin-top: 2rem;">
              <h2 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin: 0 0 1rem 0;">確認画面</h2>
              <div>
                  <div style="margin-bottom: 0.75rem;">
                      <p style="font-size: 0.875rem; font-weight: 500; color: #6b7280; margin: 0;">登録者名</p>
                      <p id="confirm-registrant" style="font-size: 1.125rem; color: #1f2937; margin: 0.25rem 0 0 0;"></p>
                  </div>
                  <div style="margin-bottom: 0.75rem;">
                      <p style="font-size: 0.875rem; font-weight: 500; color: #6b7280; margin: 0;">日付</p>
                      <p id="confirm-date" style="font-size: 1.125rem; color: #1f2937; margin: 0.25rem 0 0 0;"></p>
                  </div>
                  <div>
                      <p id="confirm-mode-label" style="font-size: 0.875rem; font-weight: 500; color: #6b7280; margin: 0;"></p>
                      <div id="confirm-items-list" style="margin-top: 0.25rem; padding: 0.75rem; background-color: #f9fafb; border-radius: 0.375rem; border: 1px solid #e5e7eb;"></div>
                  </div>
              </div>
          </div>
          <button id="register-btn" style="width: 100%; margin-top: 2rem; padding: 0.75rem 1rem; background-color: #16a34a; color: white; font-weight: 700; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;">この内容で登録する</button>
          <button id="back-to-page2-btn" type="button" style="width: 100%; margin-top: 1rem; padding: 0.75rem 1rem; background-color: white; color: #374151; font-weight: 700; font-size: 1.125rem; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer;">修正する</button>
      </div>
      
      <div id="pageRegister" style="display: none;">
          <fieldset id="pageRegister-fieldset" style="border: none; padding: 0; margin: 0;">
              <div style="margin-top: 2rem;">
                  <h2 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin: 0 0 1.25rem 0;">新規物品 仮登録</h2>
                  <p style="font-size: 0.875rem; color: #4b5563; margin: 0 0 1.25rem 0;">ここで登録された物品は、管理者がPCの「管理者ページ」で承認するまでマスターには反映されません。</p>

                  <div style="margin-bottom: 1.25rem;">
                    <button type="button" id="launch-ocr-btn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1rem; background-color: #2563eb; color: white; font-weight: 700; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.5rem; height: 1.5rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574v9.548c0 1.067.75 1.994 1.802 2.169a47.865 47.865 0 001.134.175 2.31 2.31 0 011.64 1.055l.822 1.594a2.083 2.083 0 003.487 0l.822-1.594a2.31 2.31 0 011.64-1.055 47.865 47.865 0 001.134-.175 2.31 2.31 0 011.802-2.17V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.594a2.083 2.083 0 00-3.487 0l-.822 1.594A2.31 2.31 0 016.827 6.175zM12 12.75a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" />
                      </svg>
                      <span>ラベルを撮影 (OCR)</span>
                    </button>
                  </div>

                  <div style="margin-bottom: 1.25rem;">
                      <label for="reg-name" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">品名</label>
                      <textarea id="reg-name" placeholder="品名（OCRで読み取った後、編集してください）" rows="3" style="width: 100%;"></textarea>
                  </div>
                  <div>
                    <label for="reg-category" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">カテゴリ (必須)</label>
                    <select id="reg-category" style="width: 100%;">
                        <option value="" disabled selected>-- 分類を選択してください --</option>
                        <option value="劇薬薬品">A: 劇薬薬品</option>
                        <option value="普通薬品">B: 普通薬品</option>
                        <option value="治療用資材">C: 治療用資材</option>
                        <option value="繁殖用資材">D: 繁殖用資材</option>
                        <option value="点滴用資材">E: 点滴用資材</option>
                        <option value="飼料添加物">F: 飼料添加物</option>
                        <option value="消耗品">G: 消耗品</option>
                    </select>
                  </div>
              </div>
              <button id="register-temp-btn" style="width: 100%; margin-top: 2rem; padding: 0.75rem 1rem; background-color: #16a34a; color: white; font-weight: 700; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;">この内容で仮登録する</button>
              <button id="back-to-page1-from-reg" type="button" style="width: 100%; margin-top: 1rem; padding: 0.75rem 1rem; background-color: white; color: #374151; font-weight: 700; font-size: 1.125rem; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer;">戻る</button>
          </fieldset>
      </div>
      
      <div id="success-screen" style="display: none; text-align: center; padding: 2.5rem 0;">
          <svg style="width: 4rem; height: 4rem; color: #22c55e; margin: 0 auto 1rem auto;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0 0 0.5rem 0;">登録完了</h2>
          <p id="success-message" style="color: #4b5563; margin: 0 0 1.5rem 0;">データの登録が正常に完了しました。</p>
          <button id="new-entry-btn" style="width: 100%; max-width: 20rem; margin: 0 auto; display: block; padding: 0.75rem 1rem; background-color: #2563eb; color: white; font-weight: 700; font-size: 1.125rem; border-radius: 0.375rem; border: none; cursor: pointer;">新しい記録を追加する</button>
      </div>
    </div>
    
    <input type="file" id="ocr-camera-input" style="display: none;" accept="image/*" capture="environment">

    <script>
        "use strict";
        // --- ★ 認証データ（サーバーから埋め込み・安全化） ★ ---
        // サーバー側で文字列化されている場合も、オブジェクトの場合も対応できるように処理
        const rawAuth = <?= typeof initialAuthData !== 'undefined' ? JSON.stringify(initialAuthData) : 'null' ?>;
        const AUTH_DATA = rawAuth ? ((typeof rawAuth === 'string') ? JSON.parse(rawAuth) : rawAuth) : null;

        // --- ★ グローバル変数 (状態管理) ★ ---
        const state = {
            mode: 'outbound', 
            items: [],
            currentUser: null,
            file: null, 
            appData: null,
            originalUrl: null,
            updateInterval: null 
        };
        // --- ★ DOM要素のキャッシュ ★ ---
        const $ = (id) => document.getElementById(id);
        const dom = {
            mainContent: $('main-content'), statusMessage: $('status-message'), successScreen: $('success-screen'),
            page1: $('page1'), page2: $('page2'), page3: $('page3'), mainTitle: $('main-title'),
            step1: $('step1-circle'), step2: $('step2-circle'), step3: $('step3-circle'),
            line1: $('progress-line1'), line2: $('progress-line2'),
            registrantSection: $('registrant-section'), registrantDisplay: $('registrant-display'), registrantSelect: $('registrant-select'),
            registrantDisplayContainer: $('registrant-display-container'), registrantNameHidden: $('registrant-name'),
            changeUserBtn: $('change-user-btn'), adminLink: $('admin-link-placeholder'),
            dateSection: $('date-section'), dateInput: $('date-input'), nextBtn: $('next-btn'),
            toggleModeBtn: $('toggle-mode-button'), inboundFields: $('inbound-fields'),
            photoSection: $('photo-upload-section'), selectFileBtn: $('select-file-btn'),
            launchCameraBtn: $('launch-camera-btn'),
            fileNameDisplay: $('file-name-display'),
            voucherFileInput: $('voucher-photo-file'), voucherCameraInput: $('voucher-photo-camera'),
            voucherNumberInputGroup: $('voucher-number-input-group'), voucherNumber: $('voucher-number'),
            itemAddSection: $('item-add-section'), itemSectionLegend: $('item-section-legend'),
            itemSearch: $('item-search'), itemName: $('item-name'), quantity: $('quantity'), addItemBtn: $('add-item-button'),
            addedItemsContainer: $('added-items-container'), addedItemsList: $('added-items-list'),
            confirmBtn: $('confirm-button'), backToPage1Btn: $('back-to-page1-btn'),
            confirmRegistrant: $('confirm-registrant'), confirmDate: $('confirm-date'),
            confirmModeLabel: $('confirm-mode-label'), confirmItemsList: $('confirm-items-list'),
            registerBtn: $('register-btn'), backToPage2Btn: $('back-to-page2-btn'),
            successMessage: $('success-message'), newEntryBtn: $('new-entry-btn'),
            pageRegister: $('pageRegister'),
            regName: $('reg-name'),
            regCategory: $('reg-category'),
            launchOcrBtn: $('launch-ocr-btn'),
            registerTempBtn: $('register-temp-btn'),
            backToPage1FromReg: $('back-to-page1-from-reg'),
            ocrCameraInput: $('ocr-camera-input'),
            loadingStatusText: $('loading-status-text') 
        };
    </script>

    <?!= HtmlService.createHtmlOutputFromFile('JavaScript_Api').getContent(); ?>
    <?!= HtmlService.createHtmlOutputFromFile('JavaScript_UI').getContent(); ?>
    <?!= HtmlService.createHtmlOutputFromFile('JavaScript_Main').getContent(); ?>
    
    <script>
        window.addEventListener('load', () => {
            console.log("All scripts loaded. Executing initialize()...");
            if (typeof initialize === 'function') {
                initialize(); 
            } else {
                console.error("Main.js is not loaded or initialize() is missing.");
            }
        });
    </script>
    
</body>
</html>
