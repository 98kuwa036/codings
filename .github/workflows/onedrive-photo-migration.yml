name: OneDrive Photo Migration

on:
  # Manual trigger with custom parameters
  workflow_dispatch:
    inputs:
      src_folder:
        description: 'Source folder path in OneDrive (e.g., Photos/Google Takeout)'
        required: true
        default: 'Photos/Google Takeout'
        type: string
      dst_folder:
        description: 'Destination folder path in OneDrive (e.g., Photos/Processed)'
        required: true
        default: 'Photos/Processed'
        type: string
      timezone:
        description: 'Timezone offset from UTC (e.g., 9 for JST)'
        required: false
        default: '9'
        type: string
      create_xmp:
        description: 'Create XMP sidecar files'
        required: false
        default: false
        type: boolean
      skip_existing:
        description: 'Skip already processed files (enables resume)'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run - list files without processing'
        required: false
        default: false
        type: boolean

  # Scheduled run (optional - uncomment and customize as needed)
  # schedule:
  #   - cron: '0 3 * * 0'  # Every Sunday at 3:00 AM UTC

env:
  PYTHON_VERSION: '3.11'

jobs:
  migrate-photos:
    name: Migrate Photos from OneDrive
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max for large libraries

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'onedrive-photo-migration/requirements.txt'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y exiftool libimage-exiftool-perl

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r onedrive-photo-migration/requirements.txt

      - name: Verify ExifTool installation
        run: |
          exiftool -ver
          which exiftool

      - name: Run Photo Migration
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ONEDRIVE_SRC_FOLDER: ${{ github.event.inputs.src_folder || 'Photos/Google Takeout' }}
          ONEDRIVE_DST_FOLDER: ${{ github.event.inputs.dst_folder || 'Photos/Processed' }}
          TZ_OFFSET: ${{ github.event.inputs.timezone || '9' }}
          CREATE_XMP: ${{ github.event.inputs.create_xmp || 'false' }}
          SKIP_EXISTING: ${{ github.event.inputs.skip_existing || 'true' }}
        run: |
          cd onedrive-photo-migration

          # Build command with all options
          CMD="python onedrive_photo_fixer.py"
          CMD="$CMD --src-folder '${{ github.event.inputs.src_folder || 'Photos/Google Takeout' }}'"
          CMD="$CMD --dst-folder '${{ github.event.inputs.dst_folder || 'Photos/Processed' }}'"
          CMD="$CMD --timezone ${{ github.event.inputs.timezone || '9' }}"

          if [ "${{ github.event.inputs.create_xmp }}" == "true" ]; then
            CMD="$CMD --create-xmp"
          fi

          if [ "${{ github.event.inputs.skip_existing }}" == "true" ] || [ -z "${{ github.event.inputs.skip_existing }}" ]; then
            CMD="$CMD --skip-existing"
          fi

          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "=============================================="
          echo "OneDrive Photo Migration v2.0 (Hardened)"
          echo "=============================================="
          echo "Source: ${{ github.event.inputs.src_folder || 'Photos/Google Takeout' }}"
          echo "Destination: ${{ github.event.inputs.dst_folder || 'Photos/Processed' }}"
          echo "Skip existing: ${{ github.event.inputs.skip_existing || 'true' }}"
          echo "=============================================="
          echo "Running: $CMD"
          echo ""
          eval $CMD

      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: migration-logs-${{ github.run_id }}
          path: |
            onedrive-photo-migration/*.log
          retention-days: 30

  # Optional: Notification job
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: migrate-photos
    if: always()

    steps:
      - name: Notify on success
        if: needs.migrate-photos.result == 'success'
        run: |
          echo "Migration completed successfully!"
          # Add your notification logic here (Slack, Discord, email, etc.)
          # Example for Slack:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Photo migration completed successfully!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: needs.migrate-photos.result == 'failure'
        run: |
          echo "Migration failed!"
          # Add failure notification logic here
