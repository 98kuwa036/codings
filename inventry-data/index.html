<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ£šå¸è¨˜éŒ²ãƒ„ãƒ¼ãƒ«</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
      background-color: #f3f4f6;
      color: #1f2937;
      line-height: 1.6;
    }

    .container {
      max-width: 48rem;
      margin: 0 auto;
    }

    .fixed-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(255, 255, 255, 0.95); /* èƒŒæ™¯ã‚’å°‘ã—æ¿ƒãã—ã¾ã—ãŸ */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid #3b82f6;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-state {
      filter: grayscale(1);
      pointer-events: none;
      opacity: 0.7;
    }

    .hidden {
      display: none !important; /* å¼·åˆ¶çš„ã«éè¡¨ç¤º */
    }

    header {
      position: sticky;
      top: 0;
      background-color: rgba(243, 244, 246, 0.9);
      backdrop-filter: blur(8px);
      padding: 1rem 0;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid #e5e7eb;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
    }

    main {
      padding: 1rem;
    }

    .card {
      background-color: #ffffff;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .space-y-4 > * + * {
      margin-top: 1rem;
    }

    .space-y-2 > * + * {
      margin-top: 0.5rem;
    }

    .space-y-1 > * + * {
      margin-top: 0.25rem;
    }

    .item-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
      align-items: center;
    }

    .item-row-pack {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      align-items: center;
    }

    .item-label {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .item-label-small {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.125rem;
    }

    .input-number {
      width: 5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.875rem;
    }

    .input-number:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
      border-color: transparent;
    }

    .pack-inputs {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .pack-input-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }

    .pack-input-label {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .input-pack {
      width: 4rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.875rem;
    }

    .input-pack:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
      border-color: transparent;
    }

    .btn {
      width: 100%;
      font-weight: 700;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.2s;
      white-space: nowrap; /* æŠ˜ã‚Šè¿”ã—ç¦æ­¢ */
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: #ffffff;
    }

    .btn-primary:hover:not(:disabled) {
      background-color: #2563eb;
    }

    .btn-secondary {
      background-color: #6b7280;
      color: #ffffff;
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: #4b5563;
    }

    .btn-success {
      background-color: #10b981;
      color: #ffffff;
    }

    .btn-success:hover:not(:disabled) {
      background-color: #059669;
    }

    .btn-disabled {
      background-color: #9ca3af;
      color: #ffffff;
    }

    .btn-toggle {
      background-color: #f59e0b;
      color: #ffffff;
    }

    .btn-toggle:hover:not(:disabled) {
      background-color: #d97706;
    }

    .mode-indicator {
      text-align: center;
      padding: 0.5rem;
      background-color: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 1rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #3b82f6;
    }

    .section-title-error {
      border-bottom-color: #ef4444;
      color: #dc2626;
    }

    .confirmation-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }

    .confirmation-name {
      font-weight: 500;
    }

    .confirmation-value {
      text-align: right;
      font-weight: 700;
    }

    .missing-item {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.25rem;
      padding-left: 0.5rem;
    }

    .text-center {
      text-align: center;
    }

    .text-gray {
      color: #6b7280;
    }

    .mt-6 {
      margin-top: 1.5rem;
    }

    .mb-4 {
      margin-bottom: 1rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .error-box {
      padding: 1rem;
      background-color: #fee2e2;
      border: 1px solid #fca5a5;
      color: #b91c1c;
      border-radius: 0.375rem;
    }

    .error-title {
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .skeleton {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .skeleton-line {
      height: 1.5rem;
      background-color: #e5e7eb;
      border-radius: 0.375rem;
    }

    .skeleton-input {
      height: 2.5rem;
      background-color: #e5e7eb;
      border-radius: 0.375rem;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @media (min-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>

  <div id="pc-blocker" class="fixed-overlay hidden" style="background-color: #fff; z-index: 9999;">
    <div class="text-center p-4" style="padding: 2rem;">
      <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸš«</div>
      <h2 class="section-title section-title-error" style="border: none;">PCã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯</h2>
      <p class="mt-6 text-gray" style="font-size: 1.1rem; font-weight: bold;">
        ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å°‚ç”¨ã§ã™ã€‚<br>
        ã‚¹ãƒãƒ›ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
      </p>
    </div>
  </div>

  <div id="app">

    <div id="loadingOverlay" class="fixed-overlay">
      <div class="loader"></div>
      <p>ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <div class="container">
      <header>
        <h1 id="pageTitle">æ£šå¸æ•°é‡ å…¥åŠ›</h1>
      </header>

      <main class="loading-state">
        <div id="page1">
          <form id="inventoryForm" class="card">
            <div id="modeIndicator" class="mode-indicator hidden">
              ç¾åœ¨ã®å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰: <span id="currentMode"></span>
            </div>
            <div class="mb-4">
              <button type="button" id="toggleModeBtn" class="btn btn-toggle hidden">å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹</button>
            </div>
            <div id="itemList" class="space-y-4">
              <div class="skeleton space-y-4">
                <div class="item-row">
                  <div class="skeleton-line"></div>
                  <div class="skeleton-input"></div>
                </div>
                <div class="item-row">
                  <div class="skeleton-line"></div>
                  <div class="skeleton-input"></div>
                </div>
                <div class="item-row">
                  <div class="skeleton-line"></div>
                  <div class="skeleton-input"></div>
                </div>
              </div>
            </div>
            <div class="mt-6">
              <button type="button" id="toConfirmBtn" class="btn btn-disabled" disabled>å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã™ã‚‹</button>
            </div>
          </form>
        </div>

        <div id="page2" class="hidden">
          <div class="card space-y-2">

            <div>
              <h2 class="section-title">å…¥åŠ›æ¸ˆã¿ãƒªã‚¹ãƒˆ</h2>
              <div id="confirmationList" class="space-y-2"></div>
            </div>

            <div id="missingListContainer" class="hidden">
              <h2 class="section-title section-title-error">æœªå…¥åŠ›ãƒªã‚¹ãƒˆ</h2>
              <div id="missingList" class="space-y-1 text-gray"></div>
            </div>

            <div class="mt-6 grid-2">
              <button type="button" id="backBtn" class="btn btn-secondary">æˆ»ã£ã¦ä¿®æ­£ã™ã‚‹</button>
              <button type="button" id="submitBtn" class="btn btn-success">ã“ã®å†…å®¹ã§è¨˜éŒ²ã™ã‚‹</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

<script>
(function() {
  'use strict';

  // ========================================
  // å®šæ•°
  // ========================================
  const SESSION_STORAGE_KEY = 'inventoryFormData';
  const MODE_STORAGE_KEY = 'inventoryInputMode';
  const INPUT_MODE = {
    SIMPLE: 'simple',      // æ—¢å­˜æ–¹å¼ï¼ˆæœ€å°å˜ä½ã®ã¿ï¼‰
    PACKAGING: 'packaging' // æ–°æ–¹å¼ï¼ˆè·å§¿å˜ä½+ç«¯æ•°ï¼‰
  };

  // ========================================
  // çŠ¶æ…‹ç®¡ç†
  // ========================================
  const state = {
    masterItems: [],
    isLoading: false,
    inputMode: INPUT_MODE.SIMPLE
  };

  // ========================================
  // DOMè¦ç´ 
  // ========================================
  const elements = {
    app: document.getElementById('app'),
    pcBlocker: document.getElementById('pc-blocker'),
    pageTitle: document.getElementById('pageTitle'),
    mainContent: document.querySelector('main'),
    loadingOverlay: document.getElementById('loadingOverlay'),
    page1: document.getElementById('page1'),
    page2: document.getElementById('page2'),
    toConfirmBtn: document.getElementById('toConfirmBtn'),
    backBtn: document.getElementById('backBtn'),
    submitBtn: document.getElementById('submitBtn'),
    inventoryForm: document.getElementById('inventoryForm'),
    itemList: document.getElementById('itemList'),
    confirmationList: document.getElementById('confirmationList'),
    missingListContainer: document.getElementById('missingListContainer'),
    missingList: document.getElementById('missingList'),
    toggleModeBtn: document.getElementById('toggleModeBtn'),
    modeIndicator: document.getElementById('modeIndicator'),
    currentMode: document.getElementById('currentMode')
  };

  // ========================================
  // â˜… ã‚¹ãƒãƒ›åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  // ========================================
  function isSmartPhone() {
    const ua = navigator.userAgent;
    // iPhone ã¾ãŸã¯ Androidã®ãƒ¢ãƒã‚¤ãƒ«ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‚’é™¤ãï¼‰ã‚’åˆ¤å®š
    if (ua.match(/iPhone|Android.+Mobile/)) {
      return true;
    }
    return false;
  }

  // ========================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // ========================================

  /**
   * å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—
   */
  function loadInputMode() {
    try {
      const savedMode = sessionStorage.getItem(MODE_STORAGE_KEY);
      if (savedMode && Object.values(INPUT_MODE).includes(savedMode)) {
        state.inputMode = savedMode;
      }
    } catch (e) {
      console.error('ãƒ¢ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  /**
   * å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’ä¿å­˜
   */
  function saveInputMode() {
    try {
      sessionStorage.setItem(MODE_STORAGE_KEY, state.inputMode);
    } catch (e) {
      console.error('ãƒ¢ãƒ¼ãƒ‰ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  /**
   * å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function toggleInputMode() {
    if (state.inputMode === INPUT_MODE.SIMPLE) {
      state.inputMode = INPUT_MODE.PACKAGING;
    } else {
      state.inputMode = INPUT_MODE.SIMPLE;
    }
    saveInputMode();
    clearFormData();
    elements.inventoryForm.reset();
    renderItemList(state.masterItems);
    updateModeIndicator();
    updateButtonState();
  }

  /**
   * ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
   */
  function updateModeIndicator() {
    if (state.inputMode === INPUT_MODE.SIMPLE) {
      elements.currentMode.textContent = 'æœ€å°å˜ä½ã®ã¿å…¥åŠ›';
    } else {
      elements.currentMode.textContent = 'è·å§¿å˜ä½ + ç«¯æ•°å…¥åŠ›';
    }
  }

  /**
   * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ‡æ›¿
   */
  function setLoading(isLoading) {
    state.isLoading = isLoading;
    if (isLoading) {
      elements.loadingOverlay.classList.remove('hidden');
      elements.mainContent.classList.add('loading-state');
    } else {
      elements.loadingOverlay.classList.add('hidden');
      elements.mainContent.classList.remove('loading-state');
    }
  }

  /**
   * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
   */
  function showError(error) {
    elements.itemList.innerHTML = `
      <div class="error-box">
        <p class="error-title">ã‚¨ãƒ©ãƒ¼:</p>
        <p>${error.toString()}</p>
      </div>
    `;
    elements.pageTitle.textContent = 'ã‚¨ãƒ©ãƒ¼';
  }

  // ========================================
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
  // ========================================

  function saveFormData() {
    try {
      const inputs = elements.inventoryForm.querySelectorAll('input[type="number"]');
      const data = {};
      inputs.forEach(input => {
        if (input.value.trim() !== '') {
          data[input.name] = input.value;
        }
      });
      sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã«å¤±æ•—:', e);
    }
  }

  function loadFormData() {
    try {
      const savedData = sessionStorage.getItem(SESSION_STORAGE_KEY);
      if (savedData) {
        const data = JSON.parse(savedData);
        Object.keys(data).forEach(name => {
          const input = elements.inventoryForm.elements[name];
          if (input) {
            input.value = data[name];
          }
        });
      }
    } catch (e) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
    }
  }

  function clearFormData() {
    try {
      sessionStorage.removeItem(SESSION_STORAGE_KEY);
    } catch (e) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—:', e);
    }
  }

  // ========================================
  // UIæ›´æ–°
  // ========================================

  /**
   * ç¢ºèªãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
   */
  function updateButtonState() {
    const inputs = elements.inventoryForm.querySelectorAll('input[type="number"]');
    const hasInput = Array.from(inputs).some(input => input.value.trim() !== '');

    if (hasInput) {
      elements.toConfirmBtn.disabled = false;
      elements.toConfirmBtn.className = 'btn btn-primary';
    } else {
      elements.toConfirmBtn.disabled = true;
      elements.toConfirmBtn.className = 'btn btn-disabled';
    }
  }

  /**
   * ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
   */
  function renderItemList(items) {
    if (items.length === 0) {
      elements.itemList.innerHTML = '<p class="text-center text-gray">è¡¨ç¤ºã™ã‚‹ç‰©å“ãƒã‚¹ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    let html;

    if (state.inputMode === INPUT_MODE.SIMPLE) {
      // æ—¢å­˜æ–¹å¼: æœ€å°å˜ä½ã®ã¿å…¥åŠ›
      html = items.map(item => `
        <div class="item-row">
          <div>
            <div class="item-label">${item.name}</div>
            ${item.minUnit ? `<div class="item-label-small">å˜ä½: ${item.minUnit}</div>` : ''}
          </div>
          <input type="number" name="${item.name}" placeholder="æ•°é‡" min="0" class="input-number">
        </div>
      `).join('');
    } else {
      // æ–°æ–¹å¼: è·å§¿å˜ä½ + ç«¯æ•°å…¥åŠ›
      html = items.map(item => {
        const hasPackaging = item.packUnit && item.packQuantity > 0;

        if (hasPackaging) {
          return `
            <div class="item-row-pack">
              <div>
                <div class="item-label">${item.name}</div>
                <div class="item-label-small">
                  ${item.minUnit ? `æœ€å°å˜ä½: ${item.minUnit}` : ''}
                  ${item.packUnit ? ` / è·å§¿: ${item.packUnit} (${item.packQuantity}${item.minUnit || 'å€‹'})` : ''}
                </div>
              </div>
              <div class="pack-inputs">
                <div class="pack-input-wrapper">
                  <span class="pack-input-label">${item.packUnit || 'è·å§¿'}</span>
                  <input type="number" name="pack_${item.name}" placeholder="0" min="0" class="input-pack" data-pack-quantity="${item.packQuantity}">
                </div>
                <div class="pack-input-wrapper">
                  <span class="pack-input-label">${item.minUnit || 'ç«¯æ•°'}</span>
                  <input type="number" name="rem_${item.name}" placeholder="0" min="0" class="input-pack">
                </div>
              </div>
            </div>
          `;
        } else {
          // è·å§¿æƒ…å ±ãŒãªã„å ´åˆã¯æœ€å°å˜ä½ã®ã¿
          return `
            <div class="item-row">
              <div>
                <div class="item-label">${item.name}</div>
                ${item.minUnit ? `<div class="item-label-small">å˜ä½: ${item.minUnit}</div>` : ''}
              </div>
              <input type="number" name="${item.name}" placeholder="æ•°é‡" min="0" class="input-number">
            </div>
          `;
        }
      }).join('');
    }

    elements.itemList.innerHTML = html;
  }

  /**
   * ç¢ºèªç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
   */
  function renderConfirmation() {
    elements.confirmationList.innerHTML = '';
    elements.missingList.innerHTML = '';

    let filledCount = 0;
    const missingItems = [];

    state.masterItems.forEach(item => {
      const itemName = item.name;
      let valueNum = 0;
      let hasInput = false;
      let displayText = '';

      if (state.inputMode === INPUT_MODE.SIMPLE) {
        // æ—¢å­˜æ–¹å¼
        const input = elements.inventoryForm.elements[itemName];
        const valueStr = input ? input.value.trim() : '';
        valueNum = parseInt(valueStr, 10);
        hasInput = valueStr !== '' && !isNaN(valueNum) && valueNum >= 0;
        displayText = valueNum.toString();
      } else {
        // è·å§¿å˜ä½ãƒ¢ãƒ¼ãƒ‰
        const packInput = elements.inventoryForm.elements[`pack_${itemName}`];
        const remInput = elements.inventoryForm.elements[`rem_${itemName}`];

        const packStr = packInput ? packInput.value.trim() : '';
        const remStr = remInput ? remInput.value.trim() : '';

        const packNum = parseInt(packStr, 10) || 0;
        const remNum = parseInt(remStr, 10) || 0;

        hasInput = (packStr !== '' || remStr !== '') && (packNum > 0 || remNum > 0);

        if (hasInput) {
          // æœ€å°å˜ä½ã«å¤‰æ›
          if (item.packQuantity > 0) {
            valueNum = (packNum * item.packQuantity) + remNum;
            displayText = `${packNum}${item.packUnit || 'è·å§¿'} + ${remNum}${item.minUnit || 'å€‹'} = ${valueNum}${item.minUnit || 'å€‹'}`;
          } else {
            // è·å§¿å…¥æ•°ãŒãªã„å ´åˆ
            const totalInput = packInput || remInput;
            valueNum = parseInt(totalInput.value.trim(), 10) || 0;
            displayText = valueNum.toString();
          }
        }
      }

      if (hasInput) {
        // å…¥åŠ›ã‚ã‚Š
        elements.confirmationList.innerHTML += `
          <div class="confirmation-row">
            <span class="confirmation-name">${itemName}</span>
            <span class="confirmation-value">${displayText}</span>
          </div>
        `;
        filledCount++;
      } else {
        // æœªå…¥åŠ›
        missingItems.push(itemName);
      }
    });

    // å…¥åŠ›æ¸ˆã¿ãŒ0ä»¶ã®å ´åˆ
    if (filledCount === 0) {
      elements.confirmationList.innerHTML = '<p class="text-center text-gray">å…¥åŠ›ã•ã‚ŒãŸç‰©å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    }

    // æœªå…¥åŠ›ãƒªã‚¹ãƒˆã®è¡¨ç¤º
    if (missingItems.length > 0) {
      elements.missingList.innerHTML = missingItems.map(item => `
        <div class="missing-item">${item}</div>
      `).join('');
      elements.missingListContainer.classList.remove('hidden');
    } else {
      elements.missingListContainer.classList.add('hidden');
    }
  }

  // ========================================
  // ãƒšãƒ¼ã‚¸é·ç§»
  // ========================================

  function showPage1() {
    elements.page2.classList.add('hidden');
    elements.page1.classList.remove('hidden');
    elements.pageTitle.textContent = 'æ£šå¸æ•°é‡ å…¥åŠ›';
  }

  function showPage2() {
    renderConfirmation();
    elements.page1.classList.add('hidden');
    elements.page2.classList.remove('hidden');
    elements.pageTitle.textContent = 'å…¥åŠ›å†…å®¹ ç¢ºèª';
  }

  // ========================================
  // ãƒ‡ãƒ¼ã‚¿é€ä¿¡
  // ========================================

  function submitData() {
    elements.submitBtn.disabled = true;
    elements.submitBtn.textContent = 'é€ä¿¡ä¸­...';

    const dataToWrite = state.masterItems.map(item => {
      const itemName = item.name;

      if (state.inputMode === INPUT_MODE.SIMPLE) {
        // æ—¢å­˜æ–¹å¼
        const input = elements.inventoryForm.elements[itemName];
        const valueStr = input ? input.value.trim() : '';
        const valueNum = parseInt(valueStr, 10) || 0;

        return {
          name: itemName,
          quantity: valueNum
        };
      } else {
        // è·å§¿å˜ä½ãƒ¢ãƒ¼ãƒ‰
        const packInput = elements.inventoryForm.elements[`pack_${itemName}`];
        const remInput = elements.inventoryForm.elements[`rem_${itemName}`];

        const packNum = packInput ? (parseInt(packInput.value.trim(), 10) || 0) : 0;
        const remNum = remInput ? (parseInt(remInput.value.trim(), 10) || 0) : 0;

        return {
          name: itemName,
          quantity: 0, // CSVå‡ºåŠ›æ™‚ã«å¤‰æ›ã•ã‚Œã‚‹ãŸã‚åˆæœŸå€¤
          packUnits: packNum,
          remainder: remNum,
          packQuantity: item.packQuantity || 0
        };
      }
    });

    google.script.run
      .withSuccessHandler(onWriteSuccess)
      .withFailureHandler(onWriteFailure)
      .writeInventoryData(dataToWrite);
  }

  function onWriteSuccess(response) {
    if (response.success) {
      alert(response.message);
      clearFormData();
      elements.inventoryForm.reset();
      updateButtonState();
      showPage1();
    } else {
      onWriteFailure(response);
    }
    elements.submitBtn.disabled = false;
    elements.submitBtn.textContent = 'ã“ã®å†…å®¹ã§è¨˜éŒ²ã™ã‚‹';
  }

  function onWriteFailure(error) {
    alert('æ›¸ãè¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n' + (error.error || error.toString()));
    elements.submitBtn.disabled = false;
    elements.submitBtn.textContent = 'ã“ã®å†…å®¹ã§è¨˜éŒ²ã™ã‚‹';
  }

  // ========================================
  // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
  // ========================================

  function fetchMasterItems() {
    google.script.run
      .withSuccessHandler(onMasterItemsSuccess)
      .withFailureHandler(onMasterItemsFailure)
      .getMasterItems();
  }

  function onMasterItemsSuccess(items) {
    if (items.error) {
      onMasterItemsFailure(items.error);
      return;
    }

    state.masterItems = items;

    // è·å§¿å˜ä½æƒ…å ±ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const hasPackagingInfo = items.some(item => item.packUnit && item.packQuantity > 0);

    // è·å§¿æƒ…å ±ãŒã‚ã‚‹å ´åˆã®ã¿ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    if (hasPackagingInfo) {
      elements.toggleModeBtn.classList.remove('hidden');
      elements.modeIndicator.classList.remove('hidden');
      loadInputMode();
      updateModeIndicator();
    }

    renderItemList(items);

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    elements.inventoryForm.addEventListener('input', () => {
      updateButtonState();
      saveFormData();
    });

    loadFormData();
    updateButtonState();
    setLoading(false);
  }

  function onMasterItemsFailure(error) {
    setLoading(false);
    showError(error);
  }

  // ========================================
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  // ========================================

  function setupEventListeners() {
    elements.toConfirmBtn.addEventListener('click', showPage2);
    elements.backBtn.addEventListener('click', showPage1);
    elements.submitBtn.addEventListener('click', submitData);
    elements.toggleModeBtn.addEventListener('click', toggleInputMode);
  }

  // ========================================
  // åˆæœŸåŒ–
  // ========================================

  function init() {
    // â˜… ã‚¹ãƒãƒ›ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    if (!isSmartPhone()) {
        // ã‚¹ãƒãƒ›ã§ãªã„å ´åˆã€ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’éš ã—ã¦ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’è¡¨ç¤º
        elements.app.style.display = 'none';
        elements.pcBlocker.classList.remove('hidden');
        return; // å‡¦ç†ã‚’ä¸­æ–­ï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç­‰ã‚’ã—ãªã„ï¼‰
    }

    setupEventListeners();
    fetchMasterItems();
  }

  // ========================================
  // ã‚¢ãƒ—ãƒªèµ·å‹•
  // ========================================

  document.addEventListener('DOMContentLoaded', init);

})();
</script>
</body>
</html>
