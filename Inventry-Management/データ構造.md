# データ構造仕様書

このドキュメントでは、在庫管理システムで使用するデータ構造とCSV形式を詳しく説明します。

## 目次

1. [単位の定義](#単位の定義)
2. [Excelシート構造](#excelシート構造)
3. [CSV形式](#csv形式)
4. [データフロー](#データフロー)

---

## 単位の定義

### 基本概念

#### 最小単位（Minimum Unit）
- **定義**: 実際に数える最小の個数
- **用途**: 在庫計算、データ保存
- **例**: 本、個、枚、袋、缶

#### 荷姿単位（Package Unit）
- **定義**: 注文・配送時の単位（最小単位の集合）
- **用途**: 発注、入庫
- **例**: ダース、ケース、箱、束、パック

#### 荷姿入数（Package Size）
- **定義**: 1荷姿あたりの最小単位数
- **用途**: 単位変換
- **例**: 12本/ダース、5箱/ケース、500枚/束

### 単位変換式

#### 荷姿→最小単位
```
最小単位数 = (荷姿数 × 荷姿入数) + 端数
```
例: 3ダース + 2本 = (3 × 12) + 2 = 38本

#### 最小単位→荷姿
```
荷姿数 = 最小単位数 ÷ 荷姿入数（整数部）
端数 = 最小単位数 mod 荷姿入数（余り）
```
例: 38本 = 38 ÷ 12 = 3ダース ... 2本

---

## Excelシート構造

### 1. マスター設定

| 列 | フィールド名 | データ型 | 必須 | 説明 |
|----|-------------|---------|------|------|
| A | 管理番号 | 文字列 | ○ | 物品の一意識別子（例: A001） |
| B | 物品名 | 文字列 | ○ | 物品の名称 |
| C | 最小単位名 | 文字列 | ○ | 最小単位の名称（例: 本） |
| D | 荷姿単位名 | 文字列 | ○ | 荷姿単位の名称（例: ダース） |
| E | 荷姿入数 | 整数 | ○ | 1荷姿あたりの最小単位数 |
| F | 発注点（最小単位） | 整数 | ○ | 在庫がこの値以下で発注アラート |
| G | 現在庫（最小単位） | 整数 | - | 自動計算される現在の在庫数 |
| H | 状態 | 文字列 | - | 🔴緊急/🟠注意/🟡要確認/🟢正常 |

**データ例**:
```
A001, 炭酸水, 本, ダース, 12, 24, 38, 🟢正常
A002, ティッシュ, 箱, ケース, 5, 10, 8, 🟡要確認
```

**制約**:
- 管理番号は一意
- 荷姿入数は1以上
- 発注点は0以上

---

### 2. 棚卸データ

| 列 | フィールド名 | データ型 | 必須 | 説明 |
|----|-------------|---------|------|------|
| A | 日付 | 日付 | ○ | 棚卸実施日 |
| B | 物品名 | 文字列 | ○ | マスターに登録済みの物品名 |
| C | 数量（最小単位） | 整数 | ○ | 棚卸時の在庫数（最小単位） |
| D | 単位 | 文字列 | - | 最小単位名（参考表示） |
| E | 荷姿換算 | 文字列 | - | 荷姿表示（参考表示） |

**データ例**:
```
2025-01-15, 炭酸水, 38, 本, 3ダース+2本 (38本)
2025-01-15, ティッシュ, 8, 箱, 1ケース+3箱 (8箱)
```

**制約**:
- 同一物品の場合、最新の日付のデータが現在庫計算に使用される
- 数量は0以上

---

### 3. 入出庫履歴

| 列 | フィールド名 | データ型 | 必須 | 説明 |
|----|-------------|---------|------|------|
| A | 日時 | 日時 | ○ | 入出庫の日時 |
| B | 種別 | 文字列 | ○ | "入庫" または "出庫" |
| C | 物品名 | 文字列 | ○ | マスターに登録済みの物品名 |
| D | 数量（最小単位） | 整数 | ○ | 入出庫した数量（最小単位） |
| E | 単位 | 文字列 | - | 最小単位名（参考表示） |
| F | 記録者 | 文字列 | - | 入出庫を記録した人の名前 |
| G | 荷姿換算 | 文字列 | - | 荷姿表示（参考表示） |

**データ例**:
```
2025-01-15 10:30, 入庫, 炭酸水, 24, 本, 田中, 2ダース (24本)
2025-01-15 14:15, 出庫, 炭酸水, 5, 本, 佐藤, 5本
```

**制約**:
- 種別は "入庫" または "出庫" のみ
- 数量は正の整数

---

### 4. 発注管理

| 列 | フィールド名 | データ型 | 必須 | 説明 |
|----|-------------|---------|------|------|
| A | 物品名 | 文字列 | ○ | 発注が必要な物品名 |
| B | 現在庫（最小単位） | 整数 | ○ | 現在の在庫数 |
| C | 発注点（最小単位） | 整数 | ○ | 発注点 |
| D | 不足数 | 整数 | ○ | 発注点からの不足数 |
| E | 推奨発注数（荷姿） | 整数 | ○ | 推奨する発注数（荷姿単位） |
| F | 推奨発注数（最小単位） | 整数 | ○ | 推奨する発注数（最小単位） |
| G | 発注後在庫 | 整数 | ○ | 発注後の予想在庫 |
| H | 状態 | 文字列 | - | 🔴緊急/🟠注意/🟡要確認 |

**データ例**:
```
炭酸水, 20, 24, 4, 3, 36, 56, 🟡要確認
ティッシュ, 4, 10, 6, 2, 10, 14, 🔴緊急
```

---

### 5. 在庫一覧

| 列 | フィールド名 | データ型 | 必須 | 説明 |
|----|-------------|---------|------|------|
| A | 物品名 | 文字列 | ○ | 物品名 |
| B | 現在庫（最小単位） | 文字列 | ○ | 現在庫（単位付き） |
| C | 現在庫（荷姿換算） | 文字列 | ○ | 荷姿表示 |
| D | 発注点（最小単位） | 文字列 | ○ | 発注点（単位付き） |
| E | 発注点（荷姿換算） | 文字列 | ○ | 荷姿表示 |
| F | 余裕 | 文字列 | ○ | 発注点からの差分 |
| G | 状態 | 文字列 | - | 🔴緊急/🟠注意/🟡要確認/🟢正常 |

**データ例**:
```
炭酸水, 38本, 3ダース+2本 (38本), 24本, 2ダース (24本), +14本, 🟢正常
```

---

### 6. 使用量トレンド

| 列 | フィールド名 | データ型 | 必須 | 説明 |
|----|-------------|---------|------|------|
| A | 年月 | 文字列 | ○ | 対象年月（yyyy-mm形式） |
| B | 物品名 | 文字列 | ○ | 物品名 |
| C | 使用量（最小単位） | 整数 | ○ | 当月の出庫合計 |
| D | 単位 | 文字列 | - | 最小単位名 |
| E | 前月比 | 整数 | ○ | 前月との差分 |
| F | 前月比率 | 文字列 | ○ | 前月比のパーセント |
| G | 3ヶ月平均 | 整数 | ○ | 直近3ヶ月の平均使用量 |
| H | 状態 | 文字列 | - | 🟡急増/正常 |

**データ例**:
```
2025-01, 炭酸水, 120, 本, +50, +71%, 80, 🟡急増
2025-01, ティッシュ, 30, 箱, -5, -14%, 32, 正常
```

---

## CSV形式

### 1. マスターCSV

**ファイル名**: `マスター.csv`

**形式**:
```csv
管理番号,物品名,最小単位名,荷姿単位名,荷姿入数,発注点（最小単位）
A001,炭酸水,本,ダース,12,24
A002,ティッシュ,箱,ケース,5,10
A003,コピー用紙,枚,束,500,1000
```

**エンコーディング**: UTF-8 または Shift-JIS
**改行コード**: CRLF または LF

---

### 2. 棚卸CSV

**ファイル名**: `棚卸_yyyy-mm-dd.csv`

**形式**:
```csv
日付,物品名,数量,単位
2025-01-15,炭酸水,38,本
2025-01-15,ティッシュ,8,箱
2025-01-15,コピー用紙,1500,枚
```

**注意**:
- ヘッダー行はあってもなくてもOK
- 数量は**最小単位**で記入
- 日付形式: yyyy-mm-dd

---

### 3. 入出庫CSV

**ファイル名**: `入出庫_yyyy-mm.csv`

**形式**:
```csv
日時,種別,物品名,数量,単位,記録者
2025-01-15 10:30,入庫,炭酸水,24,本,田中
2025-01-15 14:15,出庫,炭酸水,5,本,佐藤
2025-01-16 09:00,入庫,ティッシュ,10,箱,田中
```

**注意**:
- ヘッダー行推奨
- 種別は "入庫" または "出庫"
- 数量は**最小単位**で記入
- 日時形式: yyyy-mm-dd hh:mm

---

### 4. 発注リストCSV（荷姿単位版）

**ファイル名**: `発注リスト_荷姿_yyyy-mm-dd.csv`

**用途**: 業者への発注書として使用

**形式**:
```csv
物品名,発注数,単位
炭酸水,3,ダース
ティッシュ,2,ケース
```

---

### 5. 発注リストCSV（詳細版）

**ファイル名**: `発注リスト_詳細_yyyy-mm-dd.csv`

**用途**: 社内のデータ管理・分析用

**形式**:
```csv
物品名,現在庫,単位,発注点,推奨発注数（荷姿）,推奨発注数（最小単位）,発注後在庫
炭酸水,20,本,24,3ダース,36,56
ティッシュ,4,箱,10,2ケース,10,14
```

---

### 6. 使用量トレンドCSV

**ファイル名**: `使用量トレンド_yyyy-mm-dd.csv`

**形式**:
```csv
年月,物品名,使用量,単位,前月比
2025-01,炭酸水,120,本,+71%
2025-01,ティッシュ,30,箱,-14%
```

---

## データフロー

### 現在庫計算のフロー

```
[棚卸データ] → 最新の棚卸数量を取得
     ↓
[入出庫履歴] → 入庫合計を集計
     ↓
[入出庫履歴] → 出庫合計を集計
     ↓
現在庫 = 棚卸数量 + 入庫合計 - 出庫合計
     ↓
[マスター設定] → 現在庫を更新
```

### 発注判定のフロー

```
[マスター設定] → 現在庫と発注点を取得
     ↓
現在庫 <= 発注点 ? → NO → 処理終了
     ↓ YES
不足数 = (発注点 × 2) - 現在庫
     ↓
荷姿数 = 切り上げ(不足数 ÷ 荷姿入数)
     ↓
推奨発注数 = 荷姿数 × 荷姿入数
     ↓
[発注管理] → 発注リストに追加
```

### 使用急増検知のフロー

```
[入出庫履歴] → 当月の出庫合計（使用量）
     ↓
[入出庫履歴] → 前月の出庫合計
     ↓
前月比率 = (当月 - 前月) / 前月 × 100
     ↓
前月比率 >= 150% ? → YES → 🟡急増
     ↓ NO
当月 >= 3ヶ月平均 × 2 ? → YES → 🟡急増
     ↓ NO
正常
```

---

## データ制約・ビジネスルール

### 1. 単位の整合性
- すべての数値計算は**最小単位**で行う
- 表示時のみ荷姿単位に変換
- CSV保存は**最小単位**で統一

### 2. 発注数の計算ルール
- 目標在庫 = 発注点 × 2
- 荷姿単位で切り上げ（端数が出ない）
- 最小発注数 = 1荷姿

### 3. 状態判定の基準

#### 在庫状態
- 🔴緊急: 現在庫 < 発注点 × 0.5
- 🟠注意: 現在庫 < 発注点 × 0.75
- 🟡要確認: 現在庫 <= 発注点
- 🟢正常: 現在庫 > 発注点

#### 使用量状態
- 🟡急増: 前月比 >= 150% OR 当月 >= 3ヶ月平均 × 2
- 正常: 上記以外

### 4. データの有効期限
- 棚卸データ: 最新のもののみ使用
- 入出庫履歴: すべて累積（アーカイブ推奨）
- 発注リスト: その都度生成（保存不要）

---

## 拡張性の考慮

### 将来的に追加可能なフィールド

**マスター設定**:
- 仕入先情報
- 単価
- 保管場所
- カテゴリ

**入出庫履歴**:
- 取引先
- 伝票番号
- 備考

**発注管理**:
- 発注日
- 納期
- 発注先
- 発注金額

---

**このデータ構造に基づいてシステムを運用することで、正確な在庫管理と効率的な発注が可能になります。**
