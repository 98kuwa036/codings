# 入出庫記録 CSVエクスポート機能

Google Apps Scriptによる入出庫記録の差分エクスポート機能です。

## 📋 機能概要

- **差分エクスポート**: 前回エクスポート以降のデータのみを抽出（重複防止）
- **月次管理**: 月が変わると自動的に月初からのデータを取得
- **商品コード変換**: 品名を商品コードに自動変換してエクスポート
- **履歴管理**: 月ごとにエクスポート履歴を保存

## 🚀 セットアップ

### 1. Google Apps Scriptプロジェクトの作成

1. Googleフォームを作成（年・月を入力する設問を2つ作成）
2. フォームのスクリプトエディタを開く
3. `Code.gs`の内容をコピー＆ペースト

### 2. 設定値の変更

```javascript
const DATA_SPREADSHEET_ID = "あなたのスプレッドシートID";
const DATA_SHEET_NAME = "入出庫記録";
const MASTER_SHEET_NAME = "マスター";
```

### 3. トリガーの設定

1. スクリプトエディタで「トリガー」を開く
2. 「トリガーを追加」をクリック
3. 以下を設定：
   - 実行する関数: `onFormSubmit`
   - イベントのソース: フォームから
   - イベントの種類: フォーム送信時

## 📊 データ形式

### 入出庫記録シート

| 列 | 項目 | 説明 |
|----|------|------|
| A | タイムスタンプ | データ作成日時（差分判定に使用） |
| B | 記録日 | 入出庫の実施日 |
| C | 種別 | 入庫 or 出庫 |
| D | 記録者 | 担当者名 |
| E | 品名 | 物品名（商品コードに変換される） |
| F | 個数 | 数量 |

### マスターシート

| 列 | 項目 | 説明 |
|----|------|------|
| A | - | （使用しない） |
| B | 商品コード | エクスポート時の品名として使用 |
| C | 品名 | 入出庫記録の品名と照合 |

## 🔄 動作フロー

### 初回エクスポート（月初）
```
11/1 にフォーム送信 → 11月のデータを月初から全件エクスポート
                   → エクスポート日時を保存 (11/1 10:00)
```

### 2回目以降（差分エクスポート）
```
11/15 にフォーム送信 → 11/1 10:00 以降のデータのみエクスポート
                    → エクスポート日時を更新 (11/15 15:00)
```

### 月が変わった場合
```
12/1 にフォーム送信 → 12月の履歴なし → 12月初から全件エクスポート
                   → 新しい月の履歴を保存
```

## 📂 エクスポートファイル

### 保存先
```
フォームの親フォルダ/
  └── 2025/               ← 年フォルダ（自動作成）
      ├── 入出庫_2025-11-01_1000.csv
      ├── 入出庫_2025-11-15_1500.csv
      └── 入出庫_2025-11-30_1800.csv
```

### ファイル名形式
```
入出庫_YYYY-MM-DD_HHMM.csv
```

## 🛠️ 管理用関数

### エクスポート履歴の確認
```javascript
viewAllExportHistory();
```

実行ログに以下のような情報が表示されます：
```
=== エクスポート履歴一覧 ===
lastExport_2025_11: 2025/11/15 15:30:45
lastExport_2025_12: 2025/12/01 10:15:20
合計: 2件
```

### 特定月の履歴リセット
```javascript
resetExportHistory(2025, 11);  // 2025年11月をリセット
```

月初からエクスポートし直したい場合に使用します。

### 特定年の全履歴リセット
```javascript
resetYearExportHistory(2025);  // 2025年の全月をリセット
```

年度が変わる際などに使用します。

## ⚠️ 注意事項

### 重複防止の仕組み

**GAS側（推奨）**:
- 差分エクスポート機能により、同じデータを二重出力しない
- タイムスタンプで厳密に管理

**Excel VBA側**:
- 追記方式のため、同じCSVを2回インポートすると重複
- **運用ルール**: 各CSVファイルは1回だけインポートする

### 推奨運用フロー

1. **定期エクスポート**: 週次または月次でフォームを送信
2. **CSVインポート**: エクスポートされたCSVを順番にVBAでインポート
3. **月末処理**: 月末に最終エクスポートを実行

### トラブルシューティング

**Q: エクスポート件数が0になる**
- A: 前回エクスポート以降に新しいデータがない可能性があります
- 履歴をリセットしたい場合は `resetExportHistory(year, month)` を実行

**Q: 同じデータが2回エクスポートされる**
- A: PropertiesServiceの保存に失敗した可能性があります
- GASのログでエラーを確認してください

**Q: 商品コードに変換されない**
- A: マスターシートの品名が完全一致しているか確認してください
- 前後の空白にも注意

## 📝 変更履歴

- 2025-11-20: 差分エクスポート機能を実装
- 2025-11-20: 管理用関数を追加（履歴確認・リセット）
- 2025-11-20: ファイル名にタイムスタンプを追加

## 🔗 関連ドキュメント

- Excel VBA在庫管理システム: `../Inventry-Management/`
- 入出庫記録Webアプリ: `../Intake-delivery-record/`
